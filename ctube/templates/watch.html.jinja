<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>{{ title }} - CTube</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="icon" href="/static/images/favicon.png">
    <!-- Plyr CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/plyr/3.7.8/plyr.min.css" />
    <style>
        .plyr {
            --plyr-color-main: #ff0000;
        }
        .video-wrapper {
            position: relative;
            padding-bottom: calc(var(--aspect-ratio, 0.5625) * 100%);
            height: 0;
        }
        .video-wrapper > div {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="watch-body">
    <script type="application/javascript">
        const doc = document;

        function fixFrame(frame, canScroll=false) {
            const thinFrame = doc.getElementById("thin-comments-frame");
            const wideFrame = doc.getElementById("wide-comments-frame");
            const list = frame.contentWindow.document.getElementById("comment-list");

            if (!list.scrollHeight) return;

            frame.style.height = list.scrollHeight + "px";

            const pos = doc.documentElement.scrollTop || doc.body.scrollTop;

            if (canScroll && pos > frame.offsetTop)
                frame.scrollIntoView({behavior: "smooth"});

            const current = frame.contentWindow.location.href;

            if (thinFrame.contentWindow.location.href != current)
                thinFrame.src = current;

            if (wideFrame.contentWindow.location.href != current)
                wideFrame.src = current;
        }

        window.onresize = () => {
            fixFrame(doc.getElementById("thin-comments-frame"));
            fixFrame(doc.getElementById("wide-comments-frame"));
        };
    </script>

    <div class="video-column">
        <div class="video-wrapper" style="--aspect-ratio: {{ ratio }};">
            <div id="player" data-plyr-provider="youtube" data-plyr-embed-id="{{ id }}"></div>
        </div>

        <div class="video-info-line">
            <span class="title">{{ title }}</span>
            <div class="video-details">
                <span><span class="icon">üë§ </span>
                    <a href="{{ channel_url }}">{{ uploader }}</a>
                </span>
                <span><span class="icon">ü†ù</span> {{ human_date }}</span>
                <span><span class="icon">‚¶ø</span> {{ human_views }}</span>
                <span><span class="icon good">üëç</span> {{ likes }}</span>
                <span><span class="icon bad">üëé</span> {{ dislikes }}</span>
            </div>
        </div>

        <p class="description box">{{ html_description|safe }}</p>

        <iframe
            id="wide-comments-frame"
            class="comments-frame widescreen"
            src="{{ comments_url }}"
            scrolling="no"
            loading="lazy"
            onload="fixFrame(this, true)"
        ></iframe>
    </div>

    <iframe
        class="related-frame"
        src="{{ related_url }}"
        scrolling="no"
        loading="lazy"
    ></iframe>

    <iframe
        id="thin-comments-frame"
        class="comments-frame thinscreen"
        src="{{ comments_url }}"
        scrolling="no"
        loading="lazy"
        onload="fixFrame(this, true)"
    ></iframe>

    <!-- Plyr JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plyr/3.7.8/plyr.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const player = new Plyr('#player', {
                controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'],
                youtube: { noCookie: true, rel: 0, showinfo: 0, iv_load_policy: 3 }
            });
        });
    </script>
</body>
</html>
